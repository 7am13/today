<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-track { background-color: #e5e7eb; }
        .loading-overlay { background: rgba(255, 255, 255, 0.8); z-index: 100; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden relative">
        
        <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ (ì¸ì¦ ë° ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì¤‘ í‘œì‹œ) -->
        <div id="loading-overlay" class="absolute inset-0 flex flex-col items-center justify-center loading-overlay hidden">
            <svg class="animate-spin h-10 w-10 text-blue-600 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-message" class="text-gray-700 font-semibold">ì¸ì¦ ë° ë°ì´í„° ë¡œë“œ ì¤‘...</p>
        </div>

        <header class="p-6 bg-[#002FA7] text-white shadow-lg">
            <h1 class="text-3xl font-bold mb-1">í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ ğŸŒ¿</h1>
            <p class="text-blue-100 text-sm">ì¼ì •, í•  ì¼, ì‹ë‹¨, ì…€í”„ ì¼€ì–´, ì½˜í…ì¸  í•œ ê³³ì—ì„œ ê´€ë¦¬</p>
            <div id="auth-section" class="mt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                <div id="user-info" class="text-xs opacity-80">
                    ì¸ì¦ ëŒ€ê¸° ì¤‘...
                </div>
                <button id="google-login-btn" class="bg-white text-gray-800 font-semibold py-2 px-4 rounded-full shadow-md hover:bg-gray-100 transition duration-150 flex items-center hidden">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/2048px-Google_%22G%22_logo.svg.png" alt="Google logo" class="w-4 h-4 mr-2">
                    Googleë¡œ ë¡œê·¸ì¸
                </button>
                <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-red-600 transition duration-150 hidden">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
            <div id="data-path-info" class="mt-1 text-[10px] bg-black/30 p-1 rounded-sm hidden">
                ë°ì´í„° ê²½ë¡œ: <span id="base-path">N/A</span>
            </div>
        </header>
        
        <!-- ì½˜í…ì¸  ì˜ì—­: ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ í‘œì‹œ/ìˆ¨ê¹€ -->
        <div id="main-content" class="hidden">
            <nav id="tabs" class="flex border-b border-blue-100 bg-blue-50">
                <button data-tab="todo" class="tab-button w-1/5 py-3 px-2 text-center text-xs sm:text-sm font-semibold transition-colors duration-200 border-b-4 border-transparent hover:bg-blue-100" onclick="switchTab('todo')">
                    âœ… íˆ¬ë‘
                </button>
                <button data-tab="schedule" class="tab-button w-1/5 py-3 px-2 text-center text-xs sm:text-sm font-semibold transition-colors duration-200 border-b-4 border-transparent hover:bg-blue-100" onclick="switchTab('schedule')">
                    ğŸ“… ì¼ì •
                </button>
                <button data-tab="meal-plan" class="tab-1/5 py-3 px-2 text-center text-xs sm:text-sm font-semibold transition-colors duration-200 border-b-4 border-transparent hover:bg-blue-100" onclick="switchTab('meal-plan')">
                    ğŸ½ï¸ ì‹ë‹¨
                </button>
                <button data-tab="self-care" class="tab-button w-1/5 py-3 px-2 text-center text-xs sm:text-sm font-semibold transition-colors duration-200 border-b-4 border-transparent hover:bg-blue-100" onclick="switchTab('self-care')">
                    âœ¨ ì…€í”„ì¼€ì–´
                </button>
                <button data-tab="content-log" class="tab-button w-1/5 py-3 px-2 text-center text-xs sm:text-sm font-semibold transition-colors duration-200 border-b-4 border-transparent hover:bg-blue-100" onclick="switchTab('content-log')">
                    ğŸ“š ì½˜í…ì¸ 
                </button>
            </nav>

            <main class="p-6">
                
                <div id="todo-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">âœ… ì˜¤ëŠ˜ì˜ í•  ì¼</h2>
                    <form id="add-todo-form" class="flex gap-2 mb-6">
                        <div class="flex-grow relative">
                            <input type="text" id="todo-input" placeholder="ìƒˆë¡œìš´ í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš” (ë§ˆì´í¬ ì•„ì´ì½˜ í´ë¦­)" required class="w-full p-3 border border-gray-300 rounded-lg pr-12 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                            <button type="button" id="voice-input-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-blue-600 transition duration-150" title="ìŒì„± ì¸ì‹ìœ¼ë¡œ ì…ë ¥">
                                <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><rect width="4" height="12" x="10" y="2" rx="2"/><path d="M12 18v4"/><path d="M21 10V8"/><path d="M3 10V8"/><path d="M19 10c0 3.9-3.1 7-7 7s-7-3.1-7-7"/></svg>
                            </button>
                        </div>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-150 shadow-md">ì¶”ê°€</button>
                    </form>

                    <div id="voice-status" class="mb-4 text-center text-sm text-blue-600 hidden p-2 bg-blue-50 rounded-lg">
                        ë§ì”€í•˜ì„¸ìš”. ë“£ê³  ìˆìŠµë‹ˆë‹¤...
                    </div>
                    
                    <div id="todo-list" class="space-y-3 custom-scroll max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-4">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
                    </div>
                </div>

                <div id="schedule-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ“… ì˜¤ëŠ˜ì˜ ì¼ì •</h2>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
                        <input type="date" id="schedule-date-picker" class="p-3 border border-blue-300 rounded-lg text-lg font-medium focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <p class="text-blue-700 font-bold" id="selected-schedule-date-display"></p>
                    </div>

                    <form id="add-schedule-form" class="grid grid-cols-1 sm:grid-cols-4 gap-3 mb-6 p-4 border border-gray-200 rounded-lg">
                        <input type="time" id="schedule-time" required class="p-2 border border-gray-300 rounded-lg col-span-1">
                        <input type="text" id="schedule-desc" placeholder="ì¼ì • ë‚´ìš©" required class="p-2 border border-gray-300 rounded-lg col-span-2">
                        <button type="submit" class="bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition duration-150 col-span-1">ì¼ì • ì¶”ê°€</button>
                    </form>
                    
                    <div id="schedule-list" class="space-y-3 custom-scroll max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-4">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
                    </div>
                </div>

                <div id="meal-plan-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ½ï¸ ì‹ë‹¨ ê¸°ë¡</h2>

                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
                        <input type="date" id="meal-date-picker" class="p-3 border border-blue-300 rounded-lg text-lg font-medium focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <p class="text-blue-700 font-bold" id="selected-meal-date-display"></p>
                    </div>

                    <form id="add-meal-form" class="grid grid-cols-1 sm:grid-cols-5 gap-3 mb-6 p-4 border border-gray-200 rounded-lg">
                        <select id="meal-type" required class="p-2 border border-gray-300 rounded-lg col-span-1">
                            <option value="Breakfast">ì•„ì¹¨</option>
                            <option value="Lunch">ì ì‹¬</option>
                            <option value="Dinner">ì €ë…</option>
                            <option value="Snack">ê°„ì‹</option>
                        </select>
                        <input type="text" id="food-item" placeholder="ìŒì‹ëª…" required class="p-2 border border-gray-300 rounded-lg col-span-2">
                        <input type="number" id="calories" placeholder="ì¹¼ë¡œë¦¬ (ì„ íƒ)" min="0" class="p-2 border border-gray-300 rounded-lg col-span-1">
                        <button type="submit" class="bg-rose-500 text-white py-2 rounded-lg font-semibold hover:bg-rose-600 transition duration-150 col-span-1">ê¸°ë¡</button>
                    </form>

                    <div id="meal-summary" class="bg-white p-4 rounded-lg shadow-md mb-4 border border-rose-100">
                        <h3 class="text-xl font-semibold mb-2 text-rose-700">ğŸ—“ï¸ ì´ ì¹¼ë¡œë¦¬: <span id="total-calories" class="font-bold text-2xl">0</span> kcal</h3>
                        <p class="text-sm text-gray-600">ì„ íƒëœ ë‚ ì§œì˜ ì´ ì¹¼ë¡œë¦¬ í•©ì‚°ì…ë‹ˆë‹¤.</p>
                    </div>

                    <div id="meal-list" class="space-y-3 custom-scroll max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-4">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
                    </div>
                </div>
                
                <div id="self-care-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">âœ¨ ì…€í”„ ì¼€ì–´ ê¸°ë¡</h2>

                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
                        <input type="date" id="self-care-date-picker" class="p-3 border border-blue-300 rounded-lg text-lg font-medium focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <p class="text-blue-700 font-bold" id="selected-self-care-date-display"></p>
                    </div>

                    <form id="add-self-care-form" class="grid grid-cols-1 sm:grid-cols-4 gap-3 mb-6 p-4 border border-gray-200 rounded-lg">
                        <select type="text" id="care-type" required class="p-2 border border-gray-300 rounded-lg col-span-1">
                            <option value="Skin">í”¼ë¶€ (Skin)</option>
                            <option value="BodyShape">ëª¸ë§¤ (Body)</option>
                            <option value="Exercise">ìš´ë™ (Exercise)</option>
                        </select>
                        <input type="text" id="care-detail" placeholder="ê¸°ë¡ ë‚´ìš© (ex: íŒ©, ëˆˆë°”ë””, 30ë¶„ ë‹¬ë¦¬ê¸°)" required class="p-2 border border-gray-300 rounded-lg col-span-2">
                        <button type="submit" class="bg-purple-500 text-white py-2 rounded-lg font-semibold hover:bg-purple-600 transition duration-150 col-span-1">ê¸°ë¡</button>
                    </form>

                    <div id="self-care-list" class="space-y-3 custom-scroll max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-4">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
                    </div>
                </div>

                <div id="content-log-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ“š ì½˜í…ì¸  ê¸°ë¡</h2>

                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
                        <input type="date" id="content-log-date-picker" class="p-3 border border-blue-300 rounded-lg text-lg font-medium focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <p class="text-blue-700 font-bold" id="selected-content-log-date-display"></p>
                    </div>

                    <form id="add-content-log-form" class="grid grid-cols-1 sm:grid-cols-5 gap-3 mb-6 p-4 border border-gray-200 rounded-lg">
                        <select id="content-type" required class="p-2 border border-gray-300 rounded-lg col-span-1">
                            <option value="Blog">ğŸ“ ë¸”ë¡œê·¸</option>
                            <option value="YouTube">ğŸ“º ìœ íŠœë¸Œ</option>
                            <option value="Drama">ğŸ¬ ë“œë¼ë§ˆ</option>
                            <option value="Movie">ğŸ¿ ì˜í™”</option>
                            <option value="Book">ğŸ“š ì±…</option>
                            <option value="Music">ğŸµ ìŒì•…</option>
                            <option value="Art">ğŸ–¼ï¸ ì•„íŠ¸</option>
                            <option value="Other">ğŸ“ ê¸°íƒ€</option>
                        </select>
                        <input type="text" id="content-title" placeholder="ì œëª©/ì´ë¦„" required class="p-2 border border-gray-300 rounded-lg col-span-2">
                        <input type="text" id="content-note" placeholder="ê°„ë‹¨ ë©”ëª¨/ëŠë‚€ ì " class="p-2 border border-gray-300 rounded-lg col-span-1">
                        <button type="submit" class="bg-sky-500 text-white py-2 rounded-lg font-semibold hover:bg-sky-600 transition duration-150 col-span-1">ê¸°ë¡</button>
                    </form>

                    <div id="content-log-list" class="space-y-3 custom-scroll max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-4">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
                    </div>
                </div>

            </main>
        </div>
        
        <!-- ë¡œê·¸ì¸ í•„ìš” ë©”ì‹œì§€ -->
        <div id="login-required" class="p-8 text-center hidden">
            <h2 class="text-2xl font-bold text-red-600 mb-4">ğŸš¨ ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</h2>
            <p class="text-gray-700 mb-6">ë°ì´í„°ë¥¼ ë³´ê±°ë‚˜ ê¸°ë¡í•˜ë ¤ë©´ Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.</p>
            <button id="google-login-btn-large" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center mx-auto">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/2048px-Google_%22G%22_logo.svg.png" alt="Google logo" class="w-5 h-5 mr-3">
                Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê¸°
            </button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Google ë¡œê·¸ì¸ì— í•„ìš”í•œ ëª¨ë“ˆ ì¶”ê°€: GoogleAuthProvider, signInWithPopup
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, where, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===================================================================
        // â­ Firebase ì›¹ ì•± ì„¤ì • (í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©)
        // ===================================================================
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // ì´ ê³³ì€ ìº”ë²„ìŠ¤ í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-app-id';
        // __initial_auth_tokenì€ Google ë¡œê·¸ì¸ì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // ===================================================================

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let listenersStarted = false; 
        let currentTab = 'todo';

        let selectedScheduleDate = formatDate(new Date()); 
        let selectedMealDate = formatDate(new Date());
        let selectedSelfCareDate = formatDate(new Date());
        let selectedContentLogDate = formatDate(new Date());

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function showLoading(message) {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showStatusMessage(message, type = 'success') {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white z-50 transition-transform transform translate-x-full duration-300`;
            if (type === 'success') {
                statusDiv.classList.add('bg-green-600', 'font-semibold');
            } else if (type === 'error') {
                statusDiv.classList.add('bg-red-600', 'font-semibold');
            } else if (type === 'info') {
                statusDiv.classList.add('bg-blue-600');
            }
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);

            requestAnimationFrame(() => {
                statusDiv.classList.remove('translate-x-full');
            });

            setTimeout(() => {
                statusDiv.classList.add('translate-x-full');
                statusDiv.addEventListener('transitionend', () => statusDiv.remove());
            }, 3000);
        }

        // --- Google ë¡œê·¸ì¸ í•¨ìˆ˜ ---
        async function handleGoogleLogin() {
            if (!auth) {
                showStatusMessage('Firebase ì¸ì¦ ì„œë¹„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            showLoading('Google ë¡œê·¸ì¸ ì§„í–‰ ì¤‘...');
            const provider = new GoogleAuthProvider();
            try {
                // íŒì—…ì„ ì´ìš©í•œ ë¡œê·¸ì¸ ì‹œë„
                const result = await signInWithPopup(auth, provider);
                // ë¡œê·¸ì¸ì´ ì„±ê³µí•˜ë©´ onAuthStateChanged ë¦¬ìŠ¤ë„ˆê°€ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                console.log("[Auth] Google ë¡œê·¸ì¸ ì„±ê³µ:", result.user.email);
            } catch (error) {
                console.error("[Auth Error] Google ë¡œê·¸ì¸ ì‹¤íŒ¨:", error.code, error.message);
                showStatusMessage('âŒ Google ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (error.code === 'auth/popup-closed-by-user' ? 'íŒì—…ì´ ë‹«í˜' : error.code), 'error');
                hideLoading();
                // ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ UI ì´ˆê¸°í™”
                handleAuthStatus(null);
            }
        }
        
        async function handleLogout() {
            try {
                await signOut(auth);
                showStatusMessage('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            } catch (error) {
                console.error("[Auth Error] ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:", error);
                showStatusMessage('âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        }

        // --- ì¸ì¦ ìƒíƒœ ë³€í™” í•¸ë“¤ëŸ¬ ---
        function handleAuthStatus(user) {
            const userInfoDiv = document.getElementById('user-info');
            const loginBtn = document.getElementById('google-login-btn');
            const loginBtnLarge = document.getElementById('google-login-btn-large');
            const logoutBtn = document.getElementById('logout-btn');
            const mainContent = document.getElementById('main-content');
            const loginRequired = document.getElementById('login-required');

            if (user) {
                // ë¡œê·¸ì¸ ì„±ê³µ (Google ê³„ì • í™•ì¸)
                userId = user.uid;
                isAuthReady = true;
                
                const basePath = `artifacts/${appId}/users/${userId}`;
                
                // UI ì—…ë°ì´íŠ¸: ë¡œê·¸ì¸ ìƒíƒœ
                userInfoDiv.innerHTML = `ë¡œê·¸ì¸ ì™„ë£Œ | ğŸ‘¤ ${user.displayName || 'ì‚¬ìš©ì'} (<span class="font-mono text-xs bg-black/30 p-1 rounded">${user.email}</span>)`;
                document.getElementById('base-path').textContent = basePath;
                document.getElementById('data-path-info').classList.remove('hidden');
                
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                mainContent.classList.remove('hidden');
                loginRequired.classList.add('hidden');

                console.log(`[Auth Success] ì‚¬ìš©ì ID: ${userId}, ì´ë©”ì¼: ${user.email}`);
                console.log(`[Auth Success] ë°ì´í„°ë² ì´ìŠ¤ ê¸°ì¤€ ê²½ë¡œ: ${basePath}`);
                
                startRealtimeListeners();
            } else {
                // ë¡œê·¸ì•„ì›ƒ ë˜ëŠ” ì¸ì¦ ì‹¤íŒ¨
                userId = null;
                isAuthReady = false;
                listenersStarted = false; // ë¦¬ìŠ¤ë„ˆê°€ ì‹œì‘ë˜ì§€ ì•Šë„ë¡ ì¬ì„¤ì •
                
                // UI ì—…ë°ì´íŠ¸: ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
                userInfoDiv.textContent = 'ë¡œê·¸ì•„ì›ƒë¨. ë°ì´í„° ì ‘ê·¼ ë¶ˆê°€.';
                document.getElementById('data-path-info').classList.add('hidden');

                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                mainContent.classList.add('hidden');
                loginRequired.classList.remove('hidden');

                console.log("[Auth Status] ë¡œê·¸ì•„ì›ƒ ìƒíƒœ");
            }
            hideLoading();
        }

        async function initializeFirebase() {
            showLoading('Firebase ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ì¤‘...');
            setLogLevel('Debug'); // ë””ë²„ê·¸ ë¡œê·¸ í™œì„±í™”

            if (!firebaseConfig.projectId) {
                console.error("[Firebase] Firebase ì„¤ì •ì´ ë¶ˆì™„ì „í•©ë‹ˆë‹¤. config ê°ì²´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                document.getElementById('user-info').textContent = 'âš ï¸ Firebase ì„¤ì • ì˜¤ë¥˜: configë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                hideLoading();
                handleAuthStatus(null);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Google ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
                document.getElementById('google-login-btn').addEventListener('click', handleGoogleLogin);
                document.getElementById('google-login-btn-large').addEventListener('click', handleGoogleLogin);
                document.getElementById('logout-btn').addEventListener('click', handleLogout);

                // onAuthStateChanged ë¦¬ìŠ¤ë„ˆë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ì¸ì¦ ìƒíƒœ ë³€í™” ì²˜ë¦¬
                onAuthStateChanged(auth, handleAuthStatus);

            } catch (error) {
                console.error("[Firebase Initialization Error] Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error.code, error.message);
                document.getElementById('user-info').innerHTML = `<span class="text-red-400">ì´ˆê¸°í™” ì˜¤ë¥˜! âš ï¸ **${error.code}** ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</span>`;
                hideLoading();
                handleAuthStatus(null);
            }
        }

        function getCollectionRef(collectionName) {
            // Firestore ê²½ë¡œ: artifacts/{appId}/users/{userId}/{collectionName}
            const path = `artifacts/${appId}/users/${userId}/${collectionName}`;
            return collection(db, path);
        }

        // --- íƒ­ ë° ë‚ ì§œ ê´€ë¦¬ ---

        function switchTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${tabId}-tab`).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('bg-white', 'text-blue-600', 'border-blue-500');
                el.classList.add('text-gray-600');
            });

            const activeBtn = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            activeBtn.classList.remove('text-gray-600');
            activeBtn.classList.add('bg-white', 'text-blue-600', 'border-blue-500');

            if (tabId === 'schedule') updateScheduleDateDisplay();
            if (tabId === 'meal-plan') updateMealDateDisplay();
            if (tabId === 'self-care') updateSelfCareDateDisplay();
            if (tabId === 'content-log') updateContentLogDateDisplay();
        }

        window.onload = () => {
            initializeFirebase(); 
            switchTab(currentTab);
            document.getElementById('schedule-date-picker').value = selectedScheduleDate;
            document.getElementById('meal-date-picker').value = selectedMealDate;
            document.getElementById('self-care-date-picker').value = selectedSelfCareDate;
            document.getElementById('content-log-date-picker').value = selectedContentLogDate;
        };

        // --- ë¦¬ìŠ¤ë„ˆ ê´€ë¦¬ ---
        let scheduleUnsubscribe, mealPlanUnsubscribe, selfCareUnsubscribe, contentLogUnsubscribe, todoUnsubscribe;

        function unsubscribeAll() {
            if (todoUnsubscribe) todoUnsubscribe();
            if (scheduleUnsubscribe) scheduleUnsubscribe();
            if (mealPlanUnsubscribe) mealPlanUnsubscribe();
            if (selfCareUnsubscribe) selfCareUnsubscribe();
            if (contentLogUnsubscribe) contentLogUnsubscribe();
        }

        function updateListOnListenerError(listId, message) {
            document.getElementById(listId).innerHTML = `<p class="text-red-500 text-center py-4 p-4 bg-red-50 rounded-lg">${message}</p>`;
        }

        function startRealtimeListeners() {
            if (listenersStarted || !isAuthReady || !userId) return;
            listenersStarted = true;
            console.log(`[Listeners] Realtime listeners starting for user: ${userId}`);

            // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆê°€ ìˆë‹¤ë©´ í•´ì œ (ë¡œê·¸ì•„ì›ƒ í›„ ì¬ë¡œê·¸ì¸ ì‹œ ì¤‘ë³µ ë°©ì§€)
            unsubscribeAll();

            // Todo List Listener (ë‚ ì§œ í•„í„° ì—†ìŒ)
            todoUnsubscribe = onSnapshot(getCollectionRef('todos'), (snapshot) => {
                const todos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                          .sort((a, b) => (a.createdAt && b.createdAt) ? a.createdAt.toDate() - b.createdAt.toDate() : 0);
                renderTodos(todos);
            }, (error) => { 
                console.error("[Firestore Error: Todo] ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜ (ë³´ì•ˆ ê·œì¹™ ë¬¸ì œì¼ ê°€ëŠ¥ì„± ë†’ìŒ):", error); 
                updateListOnListenerError('todo-list', 'í•  ì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)');
            });

            // ë‚ ì§œ í•„í„°ê°€ ìˆëŠ” íƒ­ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupScheduleListener();
            setupMealPlanListener();
            setupSelfCareListener();
            setupContentLogListener();
        }
        
        // === Todo List Logic ===
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const todoInput = document.getElementById('todo-input');
        const voiceStatus = document.getElementById('voice-status');
        const micIcon = document.getElementById('mic-icon');
        let recognition;
        let isRecognizing = false;

        // ìŒì„± ì¸ì‹ ê¸°ëŠ¥ ì´ˆê¸°í™” (ê¸°ì¡´ ì½”ë“œë¥¼ ìœ ì§€í•˜ë˜, AuthReady ì²´í¬ë¥¼ ì¶”ê°€)
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isRecognizing = true;
                voiceStatus.classList.remove('hidden');
                micIcon.classList.add('text-red-500', 'animate-pulse');
                todoInput.placeholder = "ë§ì”€í•˜ì„¸ìš”...";
            };
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                todoInput.value = todoInput.value + transcript + ' ';
            };
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                voiceStatus.textContent = `ì˜¤ë¥˜ ë°œìƒ: ${event.error}. ë§ˆì´í¬ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.`;
                voiceStatus.classList.add('text-red-500');
            };
            recognition.onend = () => {
                isRecognizing = false;
                voiceStatus.classList.add('hidden');
                voiceStatus.classList.remove('text-red-500');
                voiceStatus.textContent = "ë§ì”€í•˜ì„¸ìš”. ë“£ê³  ìˆìŠµë‹ˆë‹¤...";
                micIcon.classList.remove('text-red-500', 'animate-pulse');
                todoInput.placeholder = "ìƒˆë¡œìš´ í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš” (ë§ˆì´í¬ ì•„ì´ì½˜ í´ë¦­)";
                todoInput.focus();
                const len = todoInput.value.length;
                todoInput.setSelectionRange(len, len);
            };

            voiceInputBtn.addEventListener('click', () => {
                if (!isAuthReady) {
                    showStatusMessage('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.', 'info');
                    return;
                }
                if (isRecognizing) {
                    recognition.stop();
                } else {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error("ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨:", e);
                        voiceStatus.textContent = "ìŒì„± ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨. ë¸Œë¼ìš°ì € ì§€ì› ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
                        voiceStatus.classList.remove('hidden');
                        voiceStatus.classList.add('text-red-500');
                    }
                }
            });
        } else {
            voiceInputBtn.disabled = true;
            micIcon.classList.add('text-gray-300');
            // ìŒì„± ì¸ì‹ ë¯¸ì§€ì› ì‹œ ë©”ì‹œì§€ í‘œì‹œ ë¡œì§
        }


        document.getElementById('add-todo-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showStatusMessage('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.', 'info');
                return;
            }
            const title = todoInput.value.trim();
            if (title === "") return;

            try {
                await addDoc(getCollectionRef('todos'), {
                    title: title,
                    completed: false,
                    // Firestore Timestamp ê°ì²´ ìƒì„±ì„ ìœ„í•´ í•„ë“œ ëª…í™•í™”
                    createdAt: new Date(),
                });
                todoInput.value = '';
                showStatusMessage('âœ… í•  ì¼ ì €ì¥ ì„±ê³µ!');
            } catch (error) {
                console.error("[Firestore Error: Todo Write] í•  ì¼ ì¶”ê°€ ì‹¤íŒ¨:", error);
                showStatusMessage('âŒ í•  ì¼ ì €ì¥ ì‹¤íŒ¨: ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        });

        async function toggleTodo(id, currentStatus) {
            if (!isAuthReady || !userId) return;
            try {
                await updateDoc(doc(getCollectionRef('todos'), id), { completed: !currentStatus });
            } catch (error) {
                console.error("[Firestore Error: Todo Update] í•  ì¼ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:", error);
                showStatusMessage('âŒ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        }

        async function deleteTodo(id) {
            if (!isAuthReady || !userId) return;
            try {
                await deleteDoc(doc(getCollectionRef('todos'), id));
                showStatusMessage('ğŸ—‘ï¸ í•  ì¼ ì‚­ì œ ì™„ë£Œ.');
            } catch (error) {
                console.error("[Firestore Error: Todo Delete] í•  ì¼ ì‚­ì œ ì‹¤íŒ¨:", error);
                showStatusMessage('âŒ ì‚­ì œ ì‹¤íŒ¨: ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        }

        function renderTodos(todos) {
            const listEl = document.getElementById('todo-list');
            listEl.innerHTML = ''; 

            if (todos.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 text-center py-4 p-4 bg-gray-50 rounded-lg">ì•„ì§ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í•  ì¼ì„ ì¶”ê°€í•˜ì„¸ìš”!</p>`;
                return;
            }

            todos.forEach(todo => {
                const isCompleted = todo.completed;
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-4 rounded-lg shadow-sm border ${isCompleted ? 'bg-green-50 border-green-300' : 'bg-white border-gray-200'} hover:shadow-md transition duration-150`;

                const createdAt = todo.createdAt ? new Date(todo.createdAt.seconds * 1000).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit'}) : '';

                item.innerHTML = `
                    <div class="flex items-center flex-grow cursor-pointer" onclick="toggleTodo('${todo.id}', ${isCompleted})">
                        <input type="checkbox" ${isCompleted ? 'checked' : ''} class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 mr-4 pointer-events-none">
                        <div class="flex flex-col">
                            <span class="text-gray-800 ${isCompleted ? 'line-through text-gray-500' : 'font-medium'} break-words">
                                ${todo.title}
                            </span>
                            <span class="text-xs text-gray-400 mt-0.5">${createdAt}</span>
                        </div>
                    </div>
                    <button class="text-red-400 hover:text-red-600 transition duration-150 p-1 ml-4" onclick="deleteTodo('${todo.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                listEl.appendChild(item);
            });
        }
        
        // === Schedule Logic ===

        function setupScheduleListener() {
            if (scheduleUnsubscribe) scheduleUnsubscribe(); 
            if (!isAuthReady || !userId) return;

            console.log(`[Schedule] Setting up listener for date: ${selectedScheduleDate}`);
            const q = query(getCollectionRef('schedules'), where('date', '==', selectedScheduleDate));
            scheduleUnsubscribe = onSnapshot(q, (snapshot) => {
                const schedules = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                            .sort((a, b) => a.time.localeCompare(b.time));
                renderSchedules(schedules);
            }, (error) => { 
                console.error("[Firestore Error: Schedule] ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜ (ë³´ì•ˆ ê·œì¹™ ë¬¸ì œì¼ ê°€ëŠ¥ì„± ë†’ìŒ):", error); 
                updateListOnListenerError('schedule-list', 'ì¼ì • ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)');
            });
            updateScheduleDateDisplay();
        }

        function updateScheduleDateDisplay() {
            document.getElementById('selected-schedule-date-display').textContent = `${selectedScheduleDate}ì˜ ì¼ì •`;
        }

        document.getElementById('schedule-date-picker').addEventListener('change', (e) => {
            selectedScheduleDate = e.target.value;
            if (isAuthReady && userId) setupScheduleListener();
        });

        document.getElementById('add-schedule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showStatusMessage('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.', 'info');
                return;
            }
            const time = document.getElementById('schedule-time').value;
            const description = document.getElementById('schedule-desc').value;

            if (!time || !description) return;

            try {
                await addDoc(getCollectionRef('schedules'), {
                    date: selectedScheduleDate,
                    time,
                    description,
                    createdAt: new Date(),
                });
                document.getElementById('schedule-desc').value = '';
                showStatusMessage('âœ… ì¼ì • ì €ì¥ ì„±ê³µ!');
            } catch (error) {
                console.error("[Firestore Error: Schedule Write] ì¼ì • ì¶”ê°€ ì‹¤íŒ¨:", error);
                showStatusMessage('âŒ ì¼ì • ì €ì¥ ì‹¤íŒ¨: ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        });

        async function deleteSchedule(id) {
            if (!isAuthReady || !userId) return;
            try {
                await deleteDoc(doc(getCollectionRef('schedules'), id));
                showStatusMessage('ğŸ—‘ï¸ ì¼ì • ì‚­ì œ ì™„ë£Œ.');
            } catch (error) {
                console.error("[Firestore Error: Schedule Delete] ì¼ì • ì‚­ì œ ì‹¤íŒ¨:", error);
                showStatusMessage('âŒ ì‚­ì œ ì‹¤íŒ¨: ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        }

        function renderSchedules(schedules) {
            const listEl = document.getElementById('schedule-list');
            listEl.innerHTML = '';

            if (schedules.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 text-center py-4 p-4 bg-gray-50 rounded-lg">ì„ íƒëœ ë‚ ì§œì— ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì¼ì •ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>`;
                return;
            }

            schedules.forEach(schedule => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-4 bg-white border border-l-4 border-green-500 rounded-lg shadow-sm hover:shadow-md transition duration-150';
                item.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-sm font-bold text-green-600 mb-1">${schedule.time}</p>
                        <p class="text-gray-800">${schedule.description}</p>
                    </div>
                    <button class="text-red-500 hover:text-red-700 transition duration-150 p-1" onclick="deleteSchedule('${schedule.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                listEl.appendChild(item);
            });
        }
        
        // === Meal Plan Logic ===

        function setupMealPlanListener() {
            if (mealPlanUnsubscribe) mealPlanUnsubscribe();
            if (!isAuthReady || !userId) return;

            console.log(`[MealPlan] Setting up listener for date: ${selectedMealDate}`);
            const q = query(getCollectionRef('meal_plans'), where('date', '==', selectedMealDate));
            mealPlanUnsubscribe = onSnapshot(q, (snapshot) => {
                const mealPlans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                            .sort((a, b) => a.createdAt.toDate() - b.createdAt.toDate());
                renderMealPlans(mealPlans);
            }, (error) => { 
                console.error("[Firestore Error: MealPlan] ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜ (ë³´ì•ˆ ê·œì¹™ ë¬¸ì œì¼ ê°€ëŠ¥ì„± ë†’ìŒ):", error); 
                updateListOnListenerError('meal-list', 'ì‹ë‹¨ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)');
            });
            updateMealDateDisplay();
        }

        function updateMealDateDisplay() {
            document.getElementById('selected-meal-date-display').textContent = `${selectedMealDate}ì˜ ì‹ë‹¨ ê¸°ë¡`;
        }

        document.getElementById('meal-date-picker').addEventListener('change', (e) => {
            selectedMealDate = e.target.value;
            if (isAuthReady && userId) setupMealPlanListener();
        });
        
        document.getElementById('add-meal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showStatusMessage('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.', 'info');
                return;
            }
            const mealType = document.getElementById('meal-type').value;
            const foodItem = document.getElementById('food-item').value;
            const calories = parseInt(document.getElementById('calories').value) || 0;

            if (!mealType || !foodItem) return;

            try {
                await addDoc(getCollectionRef('meal_plans'), {
                    date: selectedMealDate,
                    mealType,
                    foodItem,
                    calories,
                    createdAt: new Date(),
                });
                document.getElementById('food-item').value = '';
                document.getElementById('calories').value = '';
                showStatusMessage('âœ… ì‹ë‹¨ ê¸°ë¡ ì €ì¥ ì„±ê³µ!');
            } catch (error) {
                console.error("[Firestore Error: MealPlan Write] ì‹ë‹¨ ê¸°ë¡ ì‹¤íŒ¨:", error);
                showStatusMessage('âŒ ì‹ë‹¨ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        });

        async function deleteMealPlan(id) {
            if (!isAuthReady || !userId) return;
            try {
                await deleteDoc(doc(getCollectionRef('meal_plans'), id));
                showStatusMessage('ğŸ—‘ï¸ ì‹ë‹¨ ê¸°ë¡ ì‚­ì œ ì™„ë£Œ.');
            } catch (error) {
                console.error("[Firestore Error: MealPlan Delete] ì‹ë‹¨ ê¸°ë¡ ì‚­ì œ ì‹¤íŒ¨:", error);
                showStatusMessage('âŒ ì‚­ì œ ì‹¤íŒ¨: ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        }

        function getMealTypeLabel(type) {
            const map = { 'Breakfast': 'ì•„ì¹¨', 'Lunch': 'ì ì‹¬', 'Dinner': 'ì €ë…', 'Snack': 'ê°„ì‹/ê¸°íƒ€' };
            return map[type] || type;
        }

        function renderMealPlans(mealPlans) {
            const listEl = document.getElementById('meal-list');
            const totalCaloriesEl = document.getElementById('total-calories');
            listEl.innerHTML = '';
            let totalCalories = 0;

            if (mealPlans.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 text-center py-4 p-4 bg-gray-50 rounded-lg">ì„ íƒëœ ë‚ ì§œì— ì‹ë‹¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            } else {
                mealPlans.forEach(meal => {
                    totalCalories += meal.calories || 0;

                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-4 bg-white border border-l-4 border-rose-500 rounded-lg shadow-sm hover:shadow-md transition duration-150';
                    item.innerHTML = `
                        <div class="flex-grow">
                            <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full bg-rose-100 text-rose-700">${getMealTypeLabel(meal.mealType)}</span>
                            <p class="text-gray-800 mt-1"><span class="font-bold">${meal.foodItem}</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-rose-600">${meal.calories} <span class="text-sm font-normal">kcal</span></p>
                            <button class="text-red-500 hover:text-red-700 transition duration-150 p-1 mt-1" onclick="deleteMealPlan('${meal.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg> ì‚­ì œ
                            </button>
                        </div>
                    `;
                    listEl.appendChild(item);
                });
            }
            totalCaloriesEl.textContent = totalCalories.toLocaleString();
        }

        // === Self-Care Logic ===

        function setupSelfCareListener() {
            if (selfCareUnsubscribe) selfCareUnsubscribe();
            if (!isAuthReady || !userId) return;

            console.log(`[SelfCare] Setting up listener for date: ${selectedSelfCareDate}`);
            const q = query(getCollectionRef('self_care'), where('date', '==', selectedSelfCareDate));
            selfCareUnsubscribe = onSnapshot(q, (snapshot) => {
                const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                            .sort((a, b) => (a.createdAt && b.createdAt) ? a.createdAt.toDate() - b.createdAt.toDate() : 0);
                renderSelfCare(records);
            }, (error) => { 
                console.error("[Firestore Error: SelfCare] ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜ (ë³´ì•ˆ ê·œì¹™ ë¬¸ì œì¼ ê°€ëŠ¥ì„± ë†’ìŒ):", error); 
                updateListOnListenerError('self-care-list', 'ì…€í”„ ì¼€ì–´ ë¡œë“œ ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)');
            });
            updateSelfCareDateDisplay();
        }

        function updateSelfCareDateDisplay() {
            document.getElementById('selected-self-care-date-display').textContent = `${selectedSelfCareDate}ì˜ ì…€í”„ ì¼€ì–´ ê¸°ë¡`;
        }

        document.getElementById('self-care-date-picker').addEventListener('change', (e) => {
            selectedSelfCareDate = e.target.value;
            if (isAuthReady && userId) setupSelfCareListener();
        });

        document.getElementById('add-self-care-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showStatusMessage('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.', 'info');
                return;
            }
            const type = document.getElementById('care-type').value;
            const detail = document.getElementById('care-detail').value;

            if (!type || !detail) return;

            try {
                await addDoc(getCollectionRef('self_care'), {
                    date: selectedSelfCareDate,
                    type,
                    detail,
                    createdAt: new Date(),
                });
                document.getElementById('care-detail').value = '';
                showStatusMessage('âœ… ì…€í”„ ì¼€ì–´ ê¸°ë¡ ì €ì¥ ì„±ê³µ!');
            } catch (error) {
                console.error("[Firestore Error: SelfCare Write] ì…€í”„ ì¼€ì–´ ê¸°ë¡ ì‹¤íŒ¨:", error);
                showStatusMessage('âŒ ì…€í”„ ì¼€ì–´ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        });

        async function deleteSelfCare(id) {
            if (!isAuthReady || !userId) return;
            try {
                await deleteDoc(doc(getCollectionRef('self_care'), id));
                showStatusMessage('ğŸ—‘ï¸ ì…€í”„ ì¼€ì–´ ê¸°ë¡ ì‚­ì œ ì™„ë£Œ.');
            } catch (error) {
                console.error("[Firestore Error: SelfCare Delete] ì…€í”„ ì¼€ì–´ ê¸°ë¡ ì‚­ì œ ì‹¤íŒ¨:", error);
                showStatusMessage('âŒ ì‚­ì œ ì‹¤íŒ¨: ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        }

        function getCareTypeLabel(type) {
            const map = { 'Skin': 'í”¼ë¶€', 'BodyShape': 'ëª¸ë§¤', 'Exercise': 'ìš´ë™' };
            return map[type] || type;
        }

        function getCareTypeColor(type) {
            const map = {
                'Skin': 'border-blue-400 bg-blue-50',
                'BodyShape': 'border-pink-400 bg-pink-50',
                'Exercise': 'border-yellow-400 bg-yellow-50',
            };
            return map[type] || 'border-gray-400 bg-gray-50';
        }

        function renderSelfCare(records) {
            const listEl = document.getElementById('self-care-list');
            listEl.innerHTML = '';

            if (records.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 text-center py-4 p-4 bg-gray-50 rounded-lg">ì„ íƒëœ ë‚ ì§œì— ì…€í”„ ì¼€ì–´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            records.forEach(record => {
                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-4 rounded-lg shadow-sm border-l-4 ${getCareTypeColor(record.type)} hover:shadow-md transition duration-150`;
                item.innerHTML = `
                    <div class="flex-grow">
                        <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full text-gray-700 bg-white/50">${getCareTypeLabel(record.type)}</span>
                        <p class="text-gray-800 mt-1 font-medium">${record.detail}</p>
                    </div>
                    <button class="text-red-500 hover:text-red-700 transition duration-150 p-1" onclick="deleteSelfCare('${record.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                listEl.appendChild(item);
            });
        }

        // === Content Log Logic ===

        function setupContentLogListener() {
            if (contentLogUnsubscribe) contentLogUnsubscribe();
            if (!isAuthReady || !userId) return;

            console.log(`[ContentLog] Setting up listener for date: ${selectedContentLogDate}`);
            const q = query(getCollectionRef('content_log'), where('date', '==', selectedContentLogDate));
            contentLogUnsubscribe = onSnapshot(q, (snapshot) => {
                const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                            .sort((a, b) => (a.createdAt && b.createdAt) ? a.createdAt.toDate() - b.createdAt.toDate() : 0);
                renderContentLog(records);
            }, (error) => { 
                console.error("[Firestore Error: ContentLog] ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜ (ë³´ì•ˆ ê·œì¹™ ë¬¸ì œì¼ ê°€ëŠ¥ì„± ë†’ìŒ):", error); 
                updateListOnListenerError('content-log-list', 'ì½˜í…ì¸  ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)');
            });
            updateContentLogDateDisplay();
        }

        function updateContentLogDateDisplay() {
            document.getElementById('selected-content-log-date-display').textContent = `${selectedContentLogDate}ì˜ ì½˜í…ì¸  ê¸°ë¡`;
        }

        document.getElementById('content-log-date-picker').addEventListener('change', (e) => {
            selectedContentLogDate = e.target.value;
            if (isAuthReady && userId) setupContentLogListener();
        });

        document.getElementById('add-content-log-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showStatusMessage('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.', 'info');
                return;
            }
            const type = document.getElementById('content-type').value;
            const title = document.getElementById('content-title').value;
            const note = document.getElementById('content-note').value;

            if (!type || !title) return;

            try {
                await addDoc(getCollectionRef('content_log'), {
                    date: selectedContentLogDate,
                    type,
                    title,
                    note,
                    createdAt: new Date(),
                });
                document.getElementById('content-title').value = '';
                document.getElementById('content-note').value = '';
                showStatusMessage('âœ… ì½˜í…ì¸  ê¸°ë¡ ì €ì¥ ì„±ê³µ!');
            } catch (error) {
                console.error("[Firestore Error: ContentLog Write] ì½˜í…ì¸  ê¸°ë¡ ì‹¤íŒ¨:", error);
                showStatusMessage('âŒ ì½˜í…ì¸  ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        });

        async function deleteContentLog(id) {
            if (!isAuthReady || !userId) return;
            try {
                await deleteDoc(doc(getCollectionRef('content_log'), id));
                showStatusMessage('ğŸ—‘ï¸ ì½˜í…ì¸  ê¸°ë¡ ì‚­ì œ ì™„ë£Œ.');
            } catch (error) {
                console.error("[Firestore Error: ContentLog Delete] ì½˜í…ì¸  ê¸°ë¡ ì‚­ì œ ì‹¤íŒ¨:", error);
                showStatusMessage('âŒ ì‚­ì œ ì‹¤íŒ¨: ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        }

        function getContentIcon(type) {
            const map = { 'Blog': 'ğŸ“', 'YouTube': 'ğŸ“º', 'Movie': 'ğŸï¸', 'Book': 'ğŸ“š', 'Music': 'ğŸµ', 'Art': 'ğŸ–¼ï¸', 'Other': 'ğŸ”—' };
            return map[type] || 'ğŸ”—';
        }

        function getContentColor(type) {
            const map = {
                'Blog': 'border-sky-500 bg-sky-50',
                'YouTube': 'border-red-500 bg-red-50',
                'Movie': 'border-gray-800 bg-gray-100',
                'Book': 'border-amber-500 bg-amber-50',
                'Music': 'border-fuchsia-500 bg-fuchsia-50',
                'Art': 'border-teal-500 bg-teal-50',
                'Other': 'border-blue-500 bg-blue-50',
            };
            return map[type] || 'border-gray-300 bg-white';
        }

        function renderContentLog(records) {
            const listEl = document.getElementById('content-log-list');
            listEl.innerHTML = '';

            if (records.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 text-center py-4 p-4 bg-gray-50 rounded-lg">ì„ íƒëœ ë‚ ì§œì— ì½˜í…ì¸  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            records.forEach(record => {
                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-4 rounded-lg shadow-sm border-l-4 ${getContentColor(record.type)} hover:shadow-md transition duration-150`;
                item.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-sm font-bold text-gray-700 flex items-center mb-1">
                            <span class="mr-2">${getContentIcon(record.type)}</span> ${record.type}
                        </p>
                        <p class="text-gray-900 text-lg font-semibold">${record.title}</p>
                        ${record.note ? `<p class="text-gray-600 text-sm mt-1">"${record.note}"</p>` : ''}
                    </div>
                    <button class="text-red-500 hover:text-red-700 transition duration-150 p-1" onclick="deleteContentLog('${record.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                listEl.appendChild(item);
            });
        }

        window.switchTab = switchTab;
        window.toggleTodo = toggleTodo;
        window.deleteTodo = deleteTodo;
        window.deleteSchedule = deleteSchedule;
        window.deleteMealPlan = deleteMealPlan;
        window.deleteSelfCare = deleteSelfCare;
        window.deleteContentLog = deleteContentLog;

    </script>
</body>
</html>
