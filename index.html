<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-track { background-color: #e5e7eb; }
        .loading-overlay { background: rgba(255, 255, 255, 0.8); z-index: 100; }
        .tab-button.active { border-color: #002FA7; color: #002FA7; background-color: #eef2ff; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden relative">
        
        <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ (ì¸ì¦ ë° ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì¤‘ í‘œì‹œ) -->
        <div id="loading-overlay" class="absolute inset-0 flex flex-col items-center justify-center loading-overlay">
            <svg class="animate-spin h-10 w-10 text-blue-600 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-message" class="text-gray-700 font-semibold">ì¸ì¦ ë° ë°ì´í„° ë¡œë“œ ì¤‘...</p>
        </div>

        <header class="p-6 bg-[#002FA7] text-white shadow-lg">
            <h1 class="text-3xl font-bold mb-1">í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ ğŸŒ¿</h1>
            <p class="text-blue-100 text-sm">ì¼ì •, í•  ì¼, ì‹ë‹¨, ì…€í”„ ì¼€ì–´, ì½˜í…ì¸  í•œ ê³³ì—ì„œ ê´€ë¦¬</p>
            <div id="auth-section" class="mt-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                <div id="user-info" class="text-xs opacity-80">
                    ì¸ì¦ ëŒ€ê¸° ì¤‘...
                </div>
            </div>
            <div id="data-path-info" class="mt-1 text-[10px] bg-black/30 p-1 rounded-sm hidden">
                ë°ì´í„° ê²½ë¡œ: <span id="base-path">N/A</span>
            </div>
        </header>
        
        <!-- ì½˜í…ì¸  ì˜ì—­: ì¸ì¦ ì„±ê³µ í›„ í‘œì‹œ -->
        <div id="main-content" class="hidden">
            <nav id="tabs" class="flex border-b border-blue-100 bg-blue-50">
                <button data-tab="todo" class="tab-button w-1/5 py-3 px-2 text-center text-xs sm:text-sm font-semibold transition-colors duration-200 border-b-4 border-transparent hover:bg-blue-100" onclick="switchTab('todo')">
                    âœ… íˆ¬ë‘
                </button>
                <button data-tab="schedule" class="tab-button w-1/5 py-3 px-2 text-center text-xs sm:text-sm font-semibold transition-colors duration-200 border-b-4 border-transparent hover:bg-blue-100" onclick="switchTab('schedule')">
                    ğŸ“… ì¼ì •
                </button>
                <button data-tab="meal-plan" class="tab-button w-1/5 py-3 px-2 text-center text-xs sm:text-sm font-semibold transition-colors duration-200 border-b-4 border-transparent hover:bg-blue-100" onclick="switchTab('meal-plan')">
                    ğŸ½ï¸ ì‹ë‹¨
                </button>
                <button data-tab="self-care" class="tab-button w-1/5 py-3 px-2 text-center text-xs sm:text-sm font-semibold transition-colors duration-200 border-b-4 border-transparent hover:bg-blue-100" onclick="switchTab('self-care')">
                    âœ¨ ì…€í”„ì¼€ì–´
                </button>
                <button data-tab="content-log" class="tab-button w-1/5 py-3 px-2 text-center text-xs sm:text-sm font-semibold transition-colors duration-200 border-b-4 border-transparent hover:bg-blue-100" onclick="switchTab('content-log')">
                    ğŸ“š ì½˜í…ì¸ 
                </button>
            </nav>

            <main class="p-6">
                
                <div id="todo-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">âœ… ì˜¤ëŠ˜ì˜ í•  ì¼</h2>
                    <form id="add-todo-form" class="flex gap-2 mb-6">
                        <div class="flex-grow relative">
                            <input type="text" id="todo-input" placeholder="ìƒˆë¡œìš´ í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš” (ë§ˆì´í¬ ì•„ì´ì½˜ í´ë¦­)" required class="w-full p-3 border border-gray-300 rounded-lg pr-12 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                            <button type="button" id="voice-input-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-blue-600 transition duration-150" title="ìŒì„± ì¸ì‹ìœ¼ë¡œ ì…ë ¥">
                                <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><rect width="4" height="12" x="10" y="2" rx="2"/><path d="M12 18v4"/><path d="M21 10V8"/><path d="M3 10V8"/><path d="M19 10c0 3.9-3.1 7-7 7s-7-3.1-7-7"/></svg>
                            </button>
                        </div>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-150 shadow-md">ì¶”ê°€</button>
                    </form>

                    <div id="voice-status" class="mb-4 text-center text-sm text-blue-600 hidden p-2 bg-blue-50 rounded-lg">
                        ë§ì”€í•˜ì„¸ìš”. ë“£ê³  ìˆìŠµë‹ˆë‹¤...
                    </div>
                    
                    <div id="todo-list" class="space-y-3 custom-scroll max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-4">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
                    </div>
                </div>

                <div id="schedule-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ“… ì˜¤ëŠ˜ì˜ ì¼ì •</h2>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
                        <input type="date" id="schedule-date-picker" class="p-3 border border-blue-300 rounded-lg text-lg font-medium focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <p class="text-blue-700 font-bold" id="selected-schedule-date-display"></p>
                    </div>

                    <form id="add-schedule-form" class="grid grid-cols-1 sm:grid-cols-4 gap-3 mb-6 p-4 border border-gray-200 rounded-lg">
                        <input type="time" id="schedule-time" required class="p-2 border border-gray-300 rounded-lg col-span-1">
                        <input type="text" id="schedule-desc" placeholder="ì¼ì • ë‚´ìš©" required class="p-2 border border-gray-300 rounded-lg col-span-2">
                        <button type="submit" class="bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition duration-150 col-span-1">ì¼ì • ì¶”ê°€</button>
                    </form>
                    
                    <div id="schedule-list" class="space-y-3 custom-scroll max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-4">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
                    </div>
                </div>

                <div id="meal-plan-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ½ï¸ ì‹ë‹¨ ê¸°ë¡</h2>

                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
                        <input type="date" id="meal-date-picker" class="p-3 border border-blue-300 rounded-lg text-lg font-medium focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <p class="text-blue-700 font-bold" id="selected-meal-date-display"></p>
                    </div>

                    <form id="add-meal-form" class="grid grid-cols-1 sm:grid-cols-5 gap-3 mb-6 p-4 border border-gray-200 rounded-lg">
                        <select id="meal-type" required class="p-2 border border-gray-300 rounded-lg col-span-1">
                            <option value="Breakfast">ì•„ì¹¨</option>
                            <option value="Lunch">ì ì‹¬</option>
                            <option value="Dinner">ì €ë…</option>
                            <option value="Snack">ê°„ì‹</option>
                        </select>
                        <input type="text" id="food-item" placeholder="ìŒì‹ëª…" required class="p-2 border border-gray-300 rounded-lg col-span-2">
                        <input type="number" id="calories" placeholder="ì¹¼ë¡œë¦¬ (ì„ íƒ)" min="0" class="p-2 border border-gray-300 rounded-lg col-span-1">
                        <button type="submit" class="bg-rose-500 text-white py-2 rounded-lg font-semibold hover:bg-rose-600 transition duration-150 col-span-1">ê¸°ë¡</button>
                    </form>

                    <div id="meal-summary" class="bg-white p-4 rounded-lg shadow-md mb-4 border border-rose-100">
                        <h3 class="text-xl font-semibold mb-2 text-rose-700">ğŸ—“ï¸ ì´ ì¹¼ë¡œë¦¬: <span id="total-calories" class="font-bold text-2xl">0</span> kcal</h3>
                        <p class="text-sm text-gray-600">ì„ íƒëœ ë‚ ì§œì˜ ì´ ì¹¼ë¡œë¦¬ í•©ì‚°ì…ë‹ˆë‹¤.</p>
                    </div>

                    <div id="meal-list" class="space-y-3 custom-scroll max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-4">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
                    </div>
                </div>
                
                <div id="self-care-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">âœ¨ ì…€í”„ ì¼€ì–´ ê¸°ë¡</h2>

                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
                        <input type="date" id="self-care-date-picker" class="p-3 border border-blue-300 rounded-lg text-lg font-medium focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <p class="text-blue-700 font-bold" id="selected-self-care-date-display"></p>
                    </div>

                    <form id="add-self-care-form" class="grid grid-cols-1 sm:grid-cols-4 gap-3 mb-6 p-4 border border-gray-200 rounded-lg">
                        <select type="text" id="care-type" required class="p-2 border border-gray-300 rounded-lg col-span-1">
                            <option value="Skin">í”¼ë¶€ (Skin)</option>
                            <option value="BodyShape">ëª¸ë§¤ (Body)</option>
                            <option value="Exercise">ìš´ë™ (Exercise)</option>
                        </select>
                        <input type="text" id="care-detail" placeholder="ê¸°ë¡ ë‚´ìš© (ex: íŒ©, ëˆˆë°”ë””, 30ë¶„ ë‹¬ë¦¬ê¸°)" required class="p-2 border border-gray-300 rounded-lg col-span-2">
                        <button type="submit" class="bg-purple-500 text-white py-2 rounded-lg font-semibold hover:bg-purple-600 transition duration-150 col-span-1">ê¸°ë¡</button>
                    </form>

                    <div id="self-care-list" class="space-y-3 custom-scroll max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-4">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
                    </div>
                </div>

                <div id="content-log-tab" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ“š ì½˜í…ì¸  ê¸°ë¡</h2>

                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
                        <input type="date" id="content-log-date-picker" class="p-3 border border-blue-300 rounded-lg text-lg font-medium focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <p class="text-blue-700 font-bold" id="selected-content-log-date-display"></p>
                    </div>

                    <form id="add-content-log-form" class="grid grid-cols-1 sm:grid-cols-5 gap-3 mb-6 p-4 border border-gray-200 rounded-lg">
                        <select id="content-type" required class="p-2 border border-gray-300 rounded-lg col-span-1">
                            <option value="Blog">ğŸ“ ë¸”ë¡œê·¸</option>
                            <option value="YouTube">ğŸ“º ìœ íŠœë¸Œ</option>
                            <option value="Drama">ğŸ¬ ë“œë¼ë§ˆ</option>
                            <option value="Movie">ğŸ¿ ì˜í™”</option>
                            <option value="Book">ğŸ“š ì±…</option>
                            <option value="Music">ğŸµ ìŒì•…</option>
                            <option value="Art">ğŸ–¼ï¸ ì•„íŠ¸</option>
                            <option value="Other">ğŸ“ ê¸°íƒ€</option>
                        </select>
                        <input type="text" id="content-title" placeholder="ì œëª©/ì´ë¦„" required class="p-2 border border-gray-300 rounded-lg col-span-2">
                        <input type="text" id="content-note" placeholder="ê°„ë‹¨ ë©”ëª¨/ëŠë‚€ ì " class="p-2 border border-gray-300 rounded-lg col-span-1">
                        <button type="submit" class="bg-sky-500 text-white py-2 rounded-lg font-semibold hover:bg-sky-600 transition duration-150 col-span-1">ê¸°ë¡</button>
                    </form>

                    <div id="content-log-list" class="space-y-3 custom-scroll max-h-96 overflow-y-auto pr-2">
                        <p class="text-gray-500 text-center py-4">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ìµëª… ë° ì»¤ìŠ¤í…€ í† í° ë¡œê·¸ì¸ì— í•„ìš”í•œ ëª¨ë“ˆë¡œ ë³µì›
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, where, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===================================================================
        // â­ Firebase ì›¹ ì•± ì„¤ì • (í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©)
        // ===================================================================
        // Canvas í™˜ê²½ì—ì„œ ì œê³µë˜ëŠ” ì „ì—­ ë³€ìˆ˜ë“¤
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // ===================================================================

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let listenersStarted = false; 
        let currentTab = 'todo';

        let selectedScheduleDate = formatDate(new Date()); 
        let selectedMealDate = formatDate(new Date());
        let selectedSelfCareDate = formatDate(new Date());
        let selectedContentLogDate = formatDate(new Date());

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        function formatDisplayDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
            return `${year}ë…„ ${month}ì›” ${day}ì¼ (${dayOfWeek})`;
        }

        function showLoading(message) {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showStatusMessage(message, type = 'success') {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white z-50 transition-transform transform translate-x-full duration-300`;
            if (type === 'success') {
                statusDiv.classList.add('bg-green-600', 'font-semibold');
            } else if (type === 'error') {
                statusDiv.classList.add('bg-red-600', 'font-semibold');
            } else if (type === 'info') {
                statusDiv.classList.add('bg-blue-600');
            }
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);

            requestAnimationFrame(() => {
                statusDiv.classList.remove('translate-x-full');
            });

            setTimeout(() => {
                statusDiv.classList.add('translate-x-full');
                statusDiv.addEventListener('transitionend', () => statusDiv.remove());
            }, 3000);
        }

        // --- ì¸ì¦ ìƒíƒœ ë³€í™” í•¸ë“¤ëŸ¬ ---
        function handleAuthStatus(user) {
            const userInfoDiv = document.getElementById('user-info');
            const mainContent = document.getElementById('main-content');
            const basePathInfo = document.getElementById('base-path');
            
            if (user) {
                // ë¡œê·¸ì¸ ì„±ê³µ (ì»¤ìŠ¤í…€ í† í° ë˜ëŠ” ìµëª… ì‚¬ìš©ì)
                userId = user.uid;
                isAuthReady = true;
                
                userInfoDiv.innerHTML = `
                    <span class="font-bold text-yellow-300">ë¡œê·¸ì¸ ì™„ë£Œ</span> | 
                    UID: ${userId.substring(0, 8)}...
                `;
                basePathInfo.textContent = `/artifacts/${appId}/users/${userId}`;
                document.getElementById('data-path-info').classList.remove('hidden');

                mainContent.classList.remove('hidden');
                switchTab(currentTab);
                hideLoading();

                if (!listenersStarted) {
                    startListeners();
                    listenersStarted = true;
                }
                showStatusMessage('Firebase ì¸ì¦ ë° ë°ì´í„° ì—°ê²° ì„±ê³µ!', 'success');

            } else {
                // ë¡œê·¸ì•„ì›ƒ ë˜ëŠ” ì¸ì¦ ì‹¤íŒ¨
                userId = null;
                isAuthReady = false;
                listenersStarted = false; 

                userInfoDiv.innerHTML = 'ì¸ì¦ë˜ì§€ ì•ŠìŒ';
                mainContent.classList.add('hidden');
                // ì¸ì¦ ì¬ì‹œë„ ë¡œì§ì€ initAppì—ì„œ ì²˜ë¦¬ë¨
            }
        }

        // --- Firestore ê²½ë¡œ ë° ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function getCollectionRef(collectionName, date = null) {
            if (!db || !userId) {
                console.error("Firestore ë˜ëŠ” ì‚¬ìš©ì IDê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return null;
            }
            const path = `artifacts/${appId}/users/${userId}/${collectionName}`;
            
            // ë‚ ì§œ í•„í„°ë§ì´ í•„ìš”í•œ ì»¬ë ‰ì…˜ì€ ì¿¼ë¦¬ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
            if (date && ['schedule', 'meal-plan', 'self-care', 'content-log'].includes(collectionName)) {
                return query(collection(db, path), where('date', '==', date));
            }

            // ToDoëŠ” ë‚ ì§œ í•„í„°ë§ì´ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ì»¬ë ‰ì…˜ ì°¸ì¡° ìì²´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
            return collection(db, path);
        }

        // ===================================================================
        // â­ CRUD ë° ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜
        // ===================================================================

        // --- ë°ì´í„° ë Œë”ë§ í•¨ìˆ˜ ---
        function renderTodos(docs) {
            const todoList = document.getElementById('todo-list');
            todoList.innerHTML = '';
            
            if (docs.length === 0) {
                todoList.innerHTML = '<p class="text-gray-500 text-center py-4">ì•„ì§ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆ í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>';
                return;
            }

            // ì™„ë£Œ ìƒíƒœì— ë”°ë¼ ì •ë ¬: ë¯¸ì™„ë£Œ(false)ê°€ ë¨¼ì € ì˜¤ê³ , ê·¸ ë‹¤ìŒ ì™„ë£Œ(true)
            docs.sort((a, b) => a.data().completed - b.data().completed);

            docs.forEach(docSnapshot => {
                const data = docSnapshot.data();
                const docId = docSnapshot.id;
                const isCompleted = data.completed;

                const item = document.createElement('div');
                item.className = `flex items-center p-3 rounded-lg shadow-sm transition duration-150 ${isCompleted ? 'bg-green-50 border-l-4 border-green-500 opacity-70' : 'bg-white border-l-4 border-blue-500 hover:shadow-md'}`;
                item.innerHTML = `
                    <input type="checkbox" id="todo-${docId}" ${isCompleted ? 'checked' : ''} class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer" data-id="${docId}">
                    <label for="todo-${docId}" class="ml-3 text-base flex-grow cursor-pointer ${isCompleted ? 'line-through text-gray-500' : 'text-gray-800'}">
                        ${data.text}
                    </label>
                    <button data-id="${docId}" class="delete-btn text-gray-400 hover:text-red-500 ml-4 p-1 rounded transition duration-150" title="ì‚­ì œ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    </button>
                `;
                todoList.appendChild(item);
            });

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ìœ„ì„ ë°©ì‹)
            todoList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.onchange = (e) => toggleTodo(e.target.dataset.id, e.target.checked);
            });
            todoList.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => deleteItem('todo', e.currentTarget.dataset.id);
            });
        }

        function renderSchedules(docs) {
            const scheduleList = document.getElementById('schedule-list');
            scheduleList.innerHTML = '';
            document.getElementById('selected-schedule-date-display').textContent = formatDisplayDate(selectedScheduleDate);

            if (docs.length === 0) {
                scheduleList.innerHTML = '<p class="text-gray-500 text-center py-4">ì´ ë‚ ì§œì—ëŠ” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤. ì¼ì •ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>';
                return;
            }

            // ì‹œê°„ ìˆœì„œë¡œ ì •ë ¬
            docs.sort((a, b) => a.data().time.localeCompare(b.data().time));

            docs.forEach(docSnapshot => {
                const data = docSnapshot.data();
                const docId = docSnapshot.id;

                const item = document.createElement('div');
                item.className = `flex items-center p-3 rounded-lg shadow-sm bg-white border-l-4 border-green-500 hover:shadow-md transition duration-150`;
                item.innerHTML = `
                    <div class="font-mono text-lg font-bold text-green-700 min-w-[70px]">${data.time}</div>
                    <div class="ml-4 text-base flex-grow text-gray-800">${data.description}</div>
                    <button data-id="${docId}" class="delete-btn text-gray-400 hover:text-red-500 ml-4 p-1 rounded transition duration-150" title="ì‚­ì œ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    </button>
                `;
                scheduleList.appendChild(item);
            });
            
            scheduleList.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => deleteItem('schedule', e.currentTarget.dataset.id);
            });
        }

        function renderMealPlans(docs) {
            const mealList = document.getElementById('meal-list');
            mealList.innerHTML = '';
            document.getElementById('selected-meal-date-display').textContent = formatDisplayDate(selectedMealDate);
            let totalCalories = 0;

            if (docs.length === 0) {
                document.getElementById('total-calories').textContent = 0;
                mealList.innerHTML = '<p class="text-gray-500 text-center py-4">ì´ ë‚ ì§œì—ëŠ” ì‹ë‹¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            // ì‹ë‹¨ ìœ í˜•ë³„ ê·¸ë£¹í™” ë° ìˆœì„œ (ì•„ì¹¨, ì ì‹¬, ì €ë…, ê°„ì‹)
            const mealOrder = { 'Breakfast': 1, 'Lunch': 2, 'Dinner': 3, 'Snack': 4 };
            const groupedMeals = docs.reduce((acc, doc) => {
                const data = doc.data();
                const type = data.type;
                acc[type] = acc[type] || [];
                acc[type].push({...data, id: doc.id});
                totalCalories += data.calories || 0;
                return acc;
            }, {});

            const sortedTypes = Object.keys(groupedMeals).sort((a, b) => (mealOrder[a] || 99) - (mealOrder[b] || 99));

            sortedTypes.forEach(type => {
                const typeName = { 'Breakfast': 'ì•„ì¹¨ â˜€ï¸', 'Lunch': 'ì ì‹¬ ğŸœ', 'Dinner': 'ì €ë… ğŸŒ™', 'Snack': 'ê°„ì‹ ğŸª' }[type] || type;
                
                const typeHeader = document.createElement('h4');
                typeHeader.className = 'text-lg font-semibold text-rose-600 mt-4 mb-2 border-b border-rose-200 pb-1';
                typeHeader.textContent = typeName;
                mealList.appendChild(typeHeader);

                groupedMeals[type].forEach(data => {
                    const item = document.createElement('div');
                    item.className = `flex items-center justify-between p-3 rounded-lg shadow-sm bg-white border-l-4 border-rose-500 hover:shadow-md transition duration-150`;
                    item.innerHTML = `
                        <div class="flex-grow">
                            <div class="text-base font-medium text-gray-800">${data.food}</div>
                            <div class="text-sm text-gray-500">${data.calories ? `${data.calories} kcal` : 'ì¹¼ë¡œë¦¬ ë¯¸ê¸°ë¡'}</div>
                        </div>
                        <button data-id="${data.id}" class="delete-btn text-gray-400 hover:text-red-500 ml-4 p-1 rounded transition duration-150" title="ì‚­ì œ">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </button>
                    `;
                    mealList.appendChild(item);
                });
            });

            document.getElementById('total-calories').textContent = totalCalories;
            
            mealList.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => deleteItem('meal-plan', e.currentTarget.dataset.id);
            });
        }

        function renderSelfCare(docs) {
            const selfCareList = document.getElementById('self-care-list');
            selfCareList.innerHTML = '';
            document.getElementById('selected-self-care-date-display').textContent = formatDisplayDate(selectedSelfCareDate);

            if (docs.length === 0) {
                selfCareList.innerHTML = '<p class="text-gray-500 text-center py-4">ì´ ë‚ ì§œì—ëŠ” ì…€í”„ ì¼€ì–´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const careTypeNames = { 'Skin': 'ğŸ§– í”¼ë¶€', 'BodyShape': 'ğŸ’ª ëª¸ë§¤', 'Exercise': 'ğŸƒ ìš´ë™' };

            docs.forEach(docSnapshot => {
                const data = docSnapshot.data();
                const docId = docSnapshot.id;
                const typeName = careTypeNames[data.type] || data.type;

                const item = document.createElement('div');
                item.className = `flex items-center p-3 rounded-lg shadow-sm bg-white border-l-4 border-purple-500 hover:shadow-md transition duration-150`;
                item.innerHTML = `
                    <div class="font-semibold text-purple-700 min-w-[100px]">${typeName}</div>
                    <div class="ml-4 text-base flex-grow text-gray-800">${data.detail}</div>
                    <button data-id="${docId}" class="delete-btn text-gray-400 hover:text-red-500 ml-4 p-1 rounded transition duration-150" title="ì‚­ì œ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    </button>
                `;
                selfCareList.appendChild(item);
            });
            
            selfCareList.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => deleteItem('self-care', e.currentTarget.dataset.id);
            });
        }

        function renderContentLog(docs) {
            const contentLogList = document.getElementById('content-log-list');
            contentLogList.innerHTML = '';
            document.getElementById('selected-content-log-date-display').textContent = formatDisplayDate(selectedContentLogDate);

            if (docs.length === 0) {
                contentLogList.innerHTML = '<p class="text-gray-500 text-center py-4">ì´ ë‚ ì§œì—ëŠ” ì½˜í…ì¸  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const typeIcons = { 
                'Blog': 'ğŸ“', 'YouTube': 'ğŸ“º', 'Drama': 'ğŸ¬', 'Movie': 'ğŸ¿', 'Book': 'ğŸ“š', 'Music': 'ğŸµ', 'Art': 'ğŸ–¼ï¸', 'Other': 'ğŸ“' 
            };
            
            docs.forEach(docSnapshot => {
                const data = docSnapshot.data();
                const docId = docSnapshot.id;
                const icon = typeIcons[data.type] || 'â“';

                const item = document.createElement('div');
                item.className = `p-3 rounded-lg shadow-sm bg-white border-l-4 border-sky-500 hover:shadow-md transition duration-150`;
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-grow">
                            <div class="text-lg font-bold text-sky-700">${icon} ${data.title}</div>
                            <div class="text-sm text-gray-600 mt-1">${data.note || 'ë©”ëª¨ ì—†ìŒ'}</div>
                        </div>
                        <button data-id="${docId}" class="delete-btn text-gray-400 hover:text-red-500 ml-4 p-1 rounded transition duration-150" title="ì‚­ì œ">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </button>
                    </div>
                    <div class="text-xs text-gray-400 mt-2 pt-2 border-t border-gray-100">
                        ìœ í˜•: ${data.type}
                    </div>
                `;
                contentLogList.appendChild(item);
            });
            
            contentLogList.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => deleteItem('content-log', e.currentTarget.dataset.id);
            });
        }

        // --- ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (onSnapshot) ---
        function startListeners() {
            if (!isAuthReady) return;

            // 1. ToDo ë¦¬ìŠ¤ë„ˆ
            onSnapshot(getCollectionRef('todo'), (snapshot) => {
                renderTodos(snapshot.docs);
            }, (error) => {
                console.error("Error fetching todos:", error);
                showStatusMessage('í•  ì¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
            
            // 2. ì¼ì • ë¦¬ìŠ¤ë„ˆ (ì„ íƒëœ ë‚ ì§œ ê¸°ë°˜)
            const updateScheduleListener = () => {
                const q = getCollectionRef('schedule', selectedScheduleDate);
                if (q) {
                    onSnapshot(q, (snapshot) => {
                        renderSchedules(snapshot.docs);
                    }, (error) => {
                        console.error("Error fetching schedules:", error);
                        showStatusMessage('ì¼ì • ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    });
                }
            };
            updateScheduleListener();

            // 3. ì‹ë‹¨ ë¦¬ìŠ¤ë„ˆ (ì„ íƒëœ ë‚ ì§œ ê¸°ë°˜)
            const updateMealPlanListener = () => {
                const q = getCollectionRef('meal-plan', selectedMealDate);
                if (q) {
                    onSnapshot(q, (snapshot) => {
                        renderMealPlans(snapshot.docs);
                    }, (error) => {
                        console.error("Error fetching meal plans:", error);
                        showStatusMessage('ì‹ë‹¨ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    });
                }
            };
            updateMealPlanListener();

            // 4. ì…€í”„ ì¼€ì–´ ë¦¬ìŠ¤ë„ˆ (ì„ íƒëœ ë‚ ì§œ ê¸°ë°˜)
            const updateSelfCareListener = () => {
                const q = getCollectionRef('self-care', selectedSelfCareDate);
                if (q) {
                    onSnapshot(q, (snapshot) => {
                        renderSelfCare(snapshot.docs);
                    }, (error) => {
                        console.error("Error fetching self care logs:", error);
                        showStatusMessage('ì…€í”„ ì¼€ì–´ ê¸°ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    });
                }
            };
            updateSelfCareListener();

            // 5. ì½˜í…ì¸  ê¸°ë¡ ë¦¬ìŠ¤ë„ˆ (ì„ íƒëœ ë‚ ì§œ ê¸°ë°˜)
            const updateContentLogListener = () => {
                const q = getCollectionRef('content-log', selectedContentLogDate);
                if (q) {
                    onSnapshot(q, (snapshot) => {
                        renderContentLog(snapshot.docs);
                    }, (error) => {
                        console.error("Error fetching content logs:", error);
                        showStatusMessage('ì½˜í…ì¸  ê¸°ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    });
                }
            };
            updateContentLogListener();

            // ë‚ ì§œ ë³€ê²½ ì´ë²¤íŠ¸ì— ë”°ë¼ ë¦¬ìŠ¤ë„ˆ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë¥¼ ì¬í• ë‹¹ (ì‹¤ì œë¡œëŠ” ë‚ ì§œë§Œ ë³€ê²½í•˜ê³  ì¿¼ë¦¬ ì¬ì‹¤í–‰)
            document.getElementById('schedule-date-picker').onchange = (e) => {
                selectedScheduleDate = e.target.value;
                updateScheduleListener(); // ë‚ ì§œ ë³€ê²½ ì‹œ ì¿¼ë¦¬ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë‹¤ì‹œ onSnapshotì„ í˜¸ì¶œ
            };
            document.getElementById('meal-date-picker').onchange = (e) => {
                selectedMealDate = e.target.value;
                updateMealPlanListener();
            };
            document.getElementById('self-care-date-picker').onchange = (e) => {
                selectedSelfCareDate = e.target.value;
                updateSelfCareListener();
            };
            document.getElementById('content-log-date-picker').onchange = (e) => {
                selectedContentLogDate = e.target.value;
                updateContentLogListener();
            };
        }


        // --- ë°ì´í„° ì¶”ê°€ í•¨ìˆ˜ (C: Create) ---
        async function addItem(collectionName, data) {
            if (!isAuthReady) {
                showStatusMessage('ì¸ì¦ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'error');
                return;
            }
            showLoading('ë°ì´í„° ì €ì¥ ì¤‘...');
            try {
                const colRef = getCollectionRef(collectionName);
                if (!colRef) return;
                
                await addDoc(colRef, data);
                showStatusMessage('ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                console.error(`Error adding ${collectionName}:`, error);
                showStatusMessage('ê¸°ë¡ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                hideLoading();
            }
        }

        // --- í•  ì¼ ì™„ë£Œ/ë¯¸ì™„ë£Œ í† ê¸€ í•¨ìˆ˜ (U: Update) ---
        async function toggleTodo(id, completed) {
            if (!isAuthReady) return;
            try {
                const path = `artifacts/${appId}/users/${userId}/todo`;
                const itemRef = doc(db, path, id);
                await updateDoc(itemRef, { completed: completed });
            } catch (error) {
                console.error("Error updating todo:", error);
                showStatusMessage('í•  ì¼ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // --- ë°ì´í„° ì‚­ì œ í•¨ìˆ˜ (D: Delete) ---
        async function deleteItem(collectionName, id) {
            if (!isAuthReady) return;
            try {
                const path = `artifacts/${appId}/users/${userId}/${collectionName}`;
                await deleteDoc(doc(db, path, id));
                showStatusMessage('ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            } catch (error) {
                console.error(`Error deleting ${collectionName}:`, error);
                showStatusMessage('ê¸°ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ===================================================================
        // â­ íƒ­ ë° í¼ ì œì¶œ í•¸ë“¤ëŸ¬
        // ===================================================================

        function switchTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById(`${tabId}-tab`).classList.remove('hidden');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
        }

        // --- ToDo í¼ ì œì¶œ í•¸ë“¤ëŸ¬ ---
        document.getElementById('add-todo-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('todo-input');
            const text = input.value.trim();
            if (text) {
                await addItem('todo', { text: text, completed: false, createdAt: new Date() });
                input.value = '';
            }
        };

        // --- ì¼ì • í¼ ì œì¶œ í•¸ë“¤ëŸ¬ ---
        document.getElementById('add-schedule-form').onsubmit = async (e) => {
            e.preventDefault();
            const time = document.getElementById('schedule-time').value;
            const desc = document.getElementById('schedule-desc').value.trim();
            
            if (time && desc) {
                await addItem('schedule', {
                    date: selectedScheduleDate,
                    time: time,
                    description: desc,
                    createdAt: new Date()
                });
                document.getElementById('schedule-desc').value = '';
            }
        };

        // --- ì‹ë‹¨ í¼ ì œì¶œ í•¸ë“¤ëŸ¬ ---
        document.getElementById('add-meal-form').onsubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('meal-type').value;
            const food = document.getElementById('food-item').value.trim();
            const calories = parseInt(document.getElementById('calories').value) || 0;

            if (food) {
                await addItem('meal-plan', {
                    date: selectedMealDate,
                    type: type,
                    food: food,
                    calories: calories,
                    createdAt: new Date()
                });
                document.getElementById('food-item').value = '';
                document.getElementById('calories').value = '';
            }
        };

        // --- ì…€í”„ ì¼€ì–´ í¼ ì œì¶œ í•¸ë“¤ëŸ¬ ---
        document.getElementById('add-self-care-form').onsubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('care-type').value;
            const detail = document.getElementById('care-detail').value.trim();

            if (type && detail) {
                await addItem('self-care', {
                    date: selectedSelfCareDate,
                    type: type,
                    detail: detail,
                    createdAt: new Date()
                });
                document.getElementById('care-detail').value = '';
            }
        };

        // --- ì½˜í…ì¸  ê¸°ë¡ í¼ ì œì¶œ í•¸ë“¤ëŸ¬ ---
        document.getElementById('add-content-log-form').onsubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('content-type').value;
            const title = document.getElementById('content-title').value.trim();
            const note = document.getElementById('content-note').value.trim();

            if (title) {
                await addItem('content-log', {
                    date: selectedContentLogDate,
                    type: type,
                    title: title,
                    note: note,
                    createdAt: new Date()
                });
                document.getElementById('content-title').value = '';
                document.getElementById('content-note').value = '';
            }
        };

        // --- ìŒì„± ì¸ì‹ ê¸°ëŠ¥ (Web Speech API) ---
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const todoInput = document.getElementById('todo-input');
        const voiceStatus = document.getElementById('voice-status');

        if (window.webkitSpeechRecognition) {
            const SpeechRecognition = window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'ko-KR'; 
            recognition.interimResults = false;

            recognition.onstart = () => {
                voiceStatus.classList.remove('hidden');
                voiceInputBtn.innerHTML = '<svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-red-500 animate-pulse"><rect width="4" height="12" x="10" y="2" rx="2"/><path d="M12 18v4"/><path d="M21 10V8"/><path d="M3 10V8"/><path d="M19 10c0 3.9-3.1 7-7 7s-7-3.1-7-7"/></svg>';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                todoInput.value = transcript;
                voiceStatus.classList.add('hidden');
            };

            recognition.onend = () => {
                voiceStatus.classList.add('hidden');
                voiceInputBtn.innerHTML = '<svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><rect width="4" height="12" x="10" y="2" rx="2"/><path d="M12 18v4"/><path d="M21 10V8"/><path d="M3 10V8"/><path d="M19 10c0 3.9-3.1 7-7 7s-7-3.1-7-7"/></svg>';
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                voiceStatus.textContent = 'ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + event.error;
                setTimeout(() => voiceStatus.classList.add('hidden'), 2000);
            };

            voiceInputBtn.onclick = () => {
                try {
                    recognition.start();
                } catch (e) {
                    // ì´ë¯¸ ì¸ì‹ ì¤‘ì¼ ë•Œ ë°œìƒí•˜ëŠ” ì—ëŸ¬ ë¬´ì‹œ
                    if (e.name !== 'InvalidStateError') {
                        console.error('Recognition start error:', e);
                        showStatusMessage('ìŒì„± ì¸ì‹ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                }
            };
        } else {
            voiceInputBtn.title = "ìŒì„± ì¸ì‹ì€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.";
            voiceInputBtn.disabled = true;
            voiceInputBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // ===================================================================
        // â­ ì´ˆê¸°í™” ë° ì‹¤í–‰
        // ===================================================================

        // ë‚ ì§œ ì„ íƒê¸° ê¸°ë³¸ê°’ì„ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
        function initializeDatePickers() {
            const today = formatDate(new Date());

            document.getElementById('schedule-date-picker').value = today;
            document.getElementById('meal-date-picker').value = today;
            document.getElementById('self-care-date-picker').value = today;
            document.getElementById('content-log-date-picker').value = today;
            
            selectedScheduleDate = today;
            selectedMealDate = today;
            selectedSelfCareDate = today;
            selectedContentLogDate = today;

            document.getElementById('selected-schedule-date-display').textContent = formatDisplayDate(today);
            document.getElementById('selected-meal-date-display').textContent = formatDisplayDate(today);
            document.getElementById('selected-self-care-date-display').textContent = formatDisplayDate(today);
            document.getElementById('selected-content-log-date-display').textContent = formatDisplayDate(today);
        }

        async function initApp() {
            setLogLevel('debug'); // Firestore ë””ë²„ê·¸ ë¡œê¹… í™œì„±í™”
            showLoading('ì•± ì´ˆê¸°í™” ì¤‘...');

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // onAuthStateChanged ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                onAuthStateChanged(auth, handleAuthStatus);

                // ìµëª… ë˜ëŠ” ì»¤ìŠ¤í…€ í† í°ì„ ì‚¬ìš©í•œ ì´ˆê¸° ì¸ì¦ ì‹œë„
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                initializeDatePickers();

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™”/ì¸ì¦ ì˜¤ë¥˜:", error);
                showLoading('Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì˜¤ë¥˜: ' + error.code + ')');
                document.getElementById('user-info').textContent = 'ì¸ì¦ ì‹¤íŒ¨';
            }
        }

        window.onload = initApp;

    </script>
</body>
</html>
